<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Time Recorder</title>
    <meta http-equiv="refresh" content="3" id="refresh-meta">
    <style>
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #1a1a2e; color: #eee; margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: auto; background: #16213e; padding: 20px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.5); }
        h1 { color: #00d4ff; text-align: center; margin-bottom: 10px; }
        .status { text-align: center; padding: 12px; border-radius: 8px; font-weight: bold; font-size: 1.1em; margin: 15px 0; }
        .online { background: #0f3460; border: 1px solid #00d4ff; color: #00d4ff; }
        .offline { background: #520000; border: 1px solid #ff3333; color: #ff6666; animation: pulse 2s infinite; }
        @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.7; } }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 10px; border-bottom: 1px solid #334466; text-align: left; }
        th { background: #0f3460; color: #00d4ff; }
        tr:hover { background: #1e2a44; }
        footer { text-align: center; margin-top: 30px; color: #888; font-size: 0.9em; }
        .frozen { color: #ff9966; font-weight: bold; }
    </style>
</head>
<body onload="window.scrollTo(0, document.body.scrollHeight)">

<div class="container">
    <h1>Time Recorder</h1>

    <div th:class="${queueSize == null || !dbConnected} ? 'status offline' : 'status online'"
         th:text="${dbConnected == false} ? 'БД ОТКЛЮЧЕНА | В очереди: ' + ${queueSize} :
          'БД подключена | В очереди: ' + ${queueSize}">
        БД подключена | В очереди: 0
    </div>

    <table>
        <thead>
        <tr>
            <th>ID</th>
            <th>Время записи (Москва)</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="r : ${records}">
            <td th:text="${r.id}">1</td>
            <td th:text="${#temporals.format(r.recordedAt.withZoneSameInstant(T(java.time.ZoneId).of('Europe/Moscow')), 'yyyy-MM-dd HH:mm:ss')}">
                2025-01-01 12:00:00
            </td>
        </tr>
        </tbody>
    </table>

    <footer>
        Обновление каждые 3 сек
        <span id="frozen-info" style="display:none; color:#ff9966; font-weight:bold;">
            • Приложение остановлено — страница заморожена
        </span>
    </footer>
</div>

<script>
    let lastSuccess = Date.now();

    setInterval(() => {
        fetch('/actuator/health', { method: 'HEAD' })
            .then(() => {
                lastSuccess = Date.now();
            })
            .catch(() => {
                const timeSinceLastSuccess = Date.now() - lastSuccess;
                if (timeSinceLastSuccess > 8000) {
                    document.getElementById('refresh-meta').setAttribute('content', '0');
                    document.getElementById('frozen-info').style.display = 'inline';
                }
            });
    }, 5000);

    window.scrollTo(0, document.body.scrollHeight);
</script>
</body>
</html>
